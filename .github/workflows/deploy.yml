name: Deploy Portfolio Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Instalar Cloudflared
      run: |
        curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared.deb

    - name: Configurar SSH y T√∫nel
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        
        # Agregamos el host a known_hosts para evitar el prompt de "Yes/No"
        # Usamos ssh-keyscan aunque al ir por t√∫nel a veces falla, el StrictHostKeyChecking no abajo ayuda
        
        # Configuraci√≥n del ProxyCommand con los tokens de Cloudflare
        echo "Host deploy-target
          HostName ${{ secrets.SSH_HOST }}
          User ${{ secrets.SSH_USER }}
          StrictHostKeyChecking no
          ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}
        " >> ~/.ssh/config

    - name: Desplegar en Servidor
      run: |
        # AJUSTA LA RUTA DE ABAJO SI TU PROYECTO EST√Å EN OTRA CARPETA
        TARGET_DIR="/root/portfolio"
        
        echo "üöÄ Conectando al servidor..."
        ssh deploy-target "
          set -e
          
          # 1. Ir al directorio
          cd $TARGET_DIR
          
          # 2. Descartar cambios locales si los hubiera (para evitar conflictos)
          git checkout .
          
          # 3. Descargar el c√≥digo nuevo
          git pull origin main
          
          # 4. Asegurar que el script es ejecutable
          chmod +x deploy-compose.sh
          
          # 5. Ejecutar TU script con la opci√≥n 'deploy'
          ./deploy-compose.sh deploy
        "