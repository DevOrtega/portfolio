name: Deploy Portfolio Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Instalar Cloudflared
      run: |
        # Usamos wget para asegurar la descarga del binario correcto
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        cloudflared --version

    - name: Configurar SSH
      run: |
        mkdir -p ~/.ssh
        
        # 1. Guardamos la llave privada
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        
        # 2. Creamos la config SSH inyectando los secretos DIRECTAMENTE
        # Esto usa tu configuraci√≥n de Cloudflare que ya sabemos que funciona
        echo "Host deploy-target
          HostName ssh.devortega.com
          User ${{ secrets.SSH_USER }}
          IdentityFile ~/.ssh/id_ed25519
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
          ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}
        " >> ~/.ssh/config

    - name: Desplegar en Servidor
      run: |
        # ASEG√öRATE QUE ESTA RUTA ES CORRECTA EN TU SERVIDOR
        TARGET_DIR="/root/portfolio"
        
        echo "üì¶ Preparando paquete de despliegue..."
        # Creamos el paquete en /tmp para evitar que tar se vea a s√≠ mismo o cambios en el directorio actual
        tar -czf /tmp/deployment.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.env' \
          --exclude='storage' \
          --exclude='vendor' \
          --exclude='node_modules' \
          --exclude='public/build' \
          .

        echo "üöÄ Transfiriendo paquete al servidor..."
        scp /tmp/deployment.tar.gz deploy-target:/tmp/deployment.tar.gz

        echo "üèóÔ∏è Extrayendo y ejecutando despliegue remoto..."
        ssh deploy-target "
          set -e
          mkdir -p $TARGET_DIR
          
          # Extraer el nuevo c√≥digo sobre el directorio destino
          tar -xzf /tmp/deployment.tar.gz -C $TARGET_DIR
          rm /tmp/deployment.tar.gz
          
          cd $TARGET_DIR
          
          # Asegurar permisos
          chmod +x deploy-compose.sh
          chmod +x init-osrm.sh
          
          echo 'üê≥ Ejecutando script de despliegue...'
          ./deploy-compose.sh deploy
        "