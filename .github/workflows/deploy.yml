name: Deploy Portfolio Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Instalar Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        cloudflared --version

    - name: Configurar SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        
        # Validar que la key tiene el formato correcto
        if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_ed25519; then
          echo "âŒ ERROR: SSH key no tiene formato vÃ¡lido"
          echo "Debe empezar con: -----BEGIN OPENSSH PRIVATE KEY----- o -----BEGIN RSA PRIVATE KEY-----"
          exit 1
        fi
        
        echo "âœ… SSH key validada correctamente"
        
        # ConfiguraciÃ³n SSH simple
        echo "Host deploy-target
          HostName localhost
          Port 22
          User ${{ secrets.SSH_USER }}
          IdentityFile ~/.ssh/id_ed25519
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
          PasswordAuthentication no
          PubkeyAuthentication yes
        " >> ~/.ssh/config

    - name: Iniciar Cloudflared Tunnel y Desplegar
      env:
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        TARGET_DIR="/root/portfolio"
        
        echo "ðŸš€ Iniciando tÃºnel de Cloudflare..."
        cloudflared tunnel run --token $CLOUDFLARE_TUNNEL_TOKEN &
        TUNNEL_PID=$!
        
        sleep 5
        
        echo "ðŸš€ Testeando conexiÃ³n SSH..."
        if ! ssh -v deploy-target "echo âœ… SSH Connection Successful"; then
          echo "âŒ Fallo de conexiÃ³n SSH"
          kill $TUNNEL_PID 2>/dev/null || true
          exit 1
        fi
        
        echo "ðŸš€ Conectando al servidor para deploy..."
        ssh deploy-target "
          set -e
          
          # 1. Ir al directorio
          cd $TARGET_DIR
          
          # 2. Descartar cambios locales si los hubiera
          git checkout .
          
          # 3. Descargar el cÃ³digo nuevo
          git pull origin main
          
          # 4. Asegurar que el script es ejecutable
          chmod +x deploy-compose.sh
          
          # 5. Ejecutar el script de deploy
          ./deploy-compose.sh deploy
        "
        
        DEPLOY_STATUS=$?
        kill $TUNNEL_PID 2>/dev/null || true
        exit $DEPLOY_STATUS