name: Deploy Portfolio Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Instalar Cloudflared
      run: |
        # Usamos wget para asegurar la descarga del binario correcto
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        cloudflared --version

    - name: Configurar SSH
      run: |
        mkdir -p ~/.ssh
        
        # 1. Guardamos la llave privada
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        
        # 2. Creamos la config SSH inyectando los secretos DIRECTAMENTE
        # Esto usa tu configuraci√≥n de Cloudflare que ya sabemos que funciona
        echo "Host deploy-target
          HostName ssh.devortega.com
          User ${{ secrets.SSH_USER }}
          IdentityFile ~/.ssh/id_ed25519
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
          ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}
        " >> ~/.ssh/config

    - name: Descargar Mapa (Canarias)
      run: |
        mkdir -p docker/osrm
        echo "üåç Descargando datos de mapa (PBF)..."
        
        # Intentar desde OSM France (Espejo muy estable para CI)
        # Nota: Usamos gui√≥n bajo en islas_canarias que es el est√°ndar de este espejo
        URL1="https://download.openstreetmap.fr/extracts/europe/spain/islas_canarias-latest.osm.pbf"
        
        # Fallback a Geofabrik con cabeceras de navegaci√≥n real
        URL2="https://download.geofabrik.de/europe/spain/canary-islands-latest.osm.pbf"
        
        UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        REF="https://download.geofabrik.de/europe/spain.html"
        
        if curl -L -f -A "$UA" -o docker/osrm/gran-canaria.osm.pbf "$URL1"; then
          echo "‚úÖ Descargado desde OSM France"
        else
          echo "‚ö†Ô∏è Fall√≥ OSM France, intentando Geofabrik con bypass..."
          curl -L -f -A "$UA" -e "$REF" -o docker/osrm/gran-canaria.osm.pbf "$URL2"
          echo "‚úÖ Descargado desde Geofabrik"
        fi
        
        FILE_SIZE=$(stat -c%s docker/osrm/gran-canaria.osm.pbf)
        echo "Tama√±o final: $FILE_SIZE bytes"
        if [ "$FILE_SIZE" -lt 10000000 ]; then exit 1; fi

    - name: Desplegar en Servidor
      run: |
        # ASEG√öRATE QUE ESTA RUTA ES CORRECTA EN TU SERVIDOR
        TARGET_DIR="/root/portfolio"
        
        echo "üîß Reparando DNS en el servidor..."
        ssh deploy-target "echo 'nameserver 1.1.1.1' > /etc/resolv.conf || true"

        echo "üßπ Limpiando espacio en disco en el servidor (Docker Prune)..."
        ssh deploy-target "docker system prune -af && docker builder prune -af || true"
        
        echo "üìä Comprobando espacio tras limpieza..."
        ssh deploy-target "df -h /"

        echo "üì¶ Preparando y transmitiendo paquete (Direct Pipe)..."
        # Empaquetamos y enviamos directamente por SSH
        # IMPORTANTE: Aseguramos que incluimos la carpeta docker/ con el mapa
        tar -cz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.env' \
          --exclude='storage' \
          --exclude='vendor' \
          --exclude='node_modules' \
          --exclude='public/build' \
          --exclude='mdt' \
          --exclude='gtfs' \
          --exclude='docker/osrm/*.osrm*' \
          --exclude='*.deb' \
          --exclude='*.sqlite' \
          --exclude='*.log' \
          . | ssh deploy-target "
            set -e
            mkdir -p $TARGET_DIR
            
            echo 'üèóÔ∏è Extrayendo c√≥digo y mapa en tiempo real...'
            tar -xzf - -C $TARGET_DIR
            
            cd $TARGET_DIR
            
            # Asegurar permisos
            chmod +x deploy-compose.sh
            chmod +x init-osrm.sh
            
            echo 'üê≥ Ejecutando script de despliegue...'
            ./deploy-compose.sh deploy
          "